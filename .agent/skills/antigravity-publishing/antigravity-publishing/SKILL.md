---
name: antigravity-publishing
description: >
  Publishes a project to GitHub and deploys it live on Vercel. Use when the
  user mentions publishing, deploying, going live, hosting, or pushing to
  GitHub/Vercel. Handles macOS LibreSSL bugs, flaky networks, SSH key setup,
  chunked git pushes, and Vercel project creation automatically.
---

# AntiGravity Publishing Skill

## When to Use This Skill
- User says "publish this to GitHub"
- User says "deploy this on Vercel"
- User says "make it live" or "host this website"
- User says "push to GitHub and deploy"
- User wants a project available at a public URL
- User references deploying a cloned website

## Overview

This skill takes any local project folder and:
1. Initializes a git repo (or uses existing)
2. Pushes to GitHub (with automatic network/SSL workarounds)
3. Creates a Vercel project linked to the GitHub repo
4. Triggers a production deployment
5. Verifies the live URL in the browser

---

## Phase 0: Pre-Flight Environment Check

**Run this FIRST, every time.** This fixes the #1 cause of push failures on macOS.

### Step 0.1 ‚Äî Verify Homebrew Git (Critical)

macOS ships with a git linked to LibreSSL 3.3.6, which has a known
`bad record MAC` bug that corrupts SSL uploads. **Homebrew git uses OpenSSL
and does NOT have this bug.**

```bash
# Check if Homebrew git is available
/opt/homebrew/bin/git --version 2>/dev/null || git --version
```

If the output says `git version 2.x.x` and is from `/opt/homebrew/bin/git`, you're good.
If it's from `/usr/bin/git` or you see LibreSSL errors later, install Homebrew git:

```bash
brew install git
```

After install, verify git-remote-https uses the correct curl:
```bash
otool -L /opt/homebrew/Cellar/git/*/libexec/git-core/git-remote-https | grep curl
```
- ‚úÖ Good: `/opt/homebrew/opt/curl/lib/libcurl.4.dylib`
- ‚ùå Bad: `/usr/lib/libcurl.4.dylib` (system LibreSSL)

If it links to system curl, also install Homebrew curl:
```bash
brew install curl
```

### Step 0.2 ‚Äî Verify GitHub Authentication

```bash
gh auth status
```

Required scopes: `repo`, `admin:public_key`, `delete_repo` (for cleanup).
If missing scopes:
```bash
gh auth refresh -h github.com -s delete_repo
```

### Step 0.3 ‚Äî Verify SSH Key

```bash
ssh -T git@github.com 2>&1
```

Expected: `Hi USERNAME! You've successfully authenticated...`

If "Permission denied":
```bash
# Generate key if none exists
ls ~/.ssh/id_ed25519.pub || ssh-keygen -t ed25519 -C "github" -f ~/.ssh/id_ed25519 -N ""
# Add to GitHub
gh ssh-key add ~/.ssh/id_ed25519.pub --title "AntiGravity-$(hostname)"
```

### Step 0.4 ‚Äî Configure Git Defaults

```bash
git config --global init.defaultBranch main
git config --global http.version HTTP/1.1
# Set gh CLI to prefer SSH
gh config set git_protocol ssh --host github.com
```

**DO NOT** set `url.insteadOf` globally ‚Äî it causes issues when you need
HTTPS fallback. Instead, set SSH remotes explicitly per-repo.

### Pre-Flight Checklist

```
- [ ] Homebrew git is installed and on PATH
- [ ] `gh auth status` shows logged in with correct scopes
- [ ] `ssh -T git@github.com` authenticates successfully
- [ ] `git config --global init.defaultBranch` is `main`
```

---

## Phase 1: Prepare the Git Repository

### Step 1.1 ‚Äî Create .gitignore

If no `.gitignore` exists, create one appropriate for the project type:

**For static HTML sites:**
```
.DS_Store
Thumbs.db
*.log
.env
.env.local
```

**For React/Vite/Next.js apps:**
```
node_modules/
dist/
build/
.next/
.env
.env.local
.DS_Store
*.log
```

### Step 1.2 ‚Äî Initialize Git

```bash
cd /path/to/project
git init
git add -A
git status --short
```

**‚ö†Ô∏è Watch for embedded git repos.** If you see warnings like
`adding embedded git repository`, remove them:
```bash
git rm --cached path/to/embedded-repo
echo "path/to/embedded-repo/" >> .gitignore
git add -A
```

### Step 1.3 ‚Äî Handle Large Files

Check for files that will slow down pushes on flaky networks:
```bash
find . -not -path './.git/*' -type f -size +100k | head -20
```

If `package-lock.json` is present and > 100KB, consider adding it to `.gitignore`
(it's auto-generated by `npm install`).

### Step 1.4 ‚Äî Commit

```bash
git commit -m "üöÄ Initial commit: [PROJECT_NAME]

[Brief description of what this project is]"
```

---

## Phase 2: Push to GitHub

### Step 2.1 ‚Äî Create the GitHub Repository

```bash
gh repo create REPO_NAME --public --description "DESCRIPTION" 2>&1
```

Use `--private` if the user requests a private repo.

### Step 2.2 ‚Äî Set SSH Remote and Push

```bash
# ALWAYS use SSH remote (avoids LibreSSL issues entirely)
git remote add origin git@github.com:USERNAME/REPO_NAME.git
git push -u origin main
```

### Step 2.3 ‚Äî Handle Push Failures

If the push fails, follow this escalation ladder:

#### Level 1: Simple Retry (transient network)
```bash
sleep 5 && git push -u origin main
```

#### Level 2: Chunked Pushing (flaky connection)
Split the commit into smaller pieces:
```bash
# Reset to unstaged
git reset HEAD~1

# Push config/small files first
git add .gitignore README.md package.json tsconfig.json vite.config.ts
git commit -m "Add project config"
git push origin main

# Push source files
git add src/
git commit -m "Add source code"
sleep 3 && git push origin main

# Push remaining files
git add -A
git commit -m "Add remaining assets"
sleep 3 && git push origin main
```

**Key rule:** Keep each commit under ~50KB of diff. Skip `package-lock.json`
if the network is really bad.

#### Level 3: Retry Loop (persistent drops)
```bash
for i in 1 2 3 4 5; do
  echo "Push attempt $i..."
  if git push origin main 2>&1 | grep -q "main -> main"; then
    echo "‚úÖ Success!"
    break
  fi
  sleep $((i * 5))
done
```

#### Level 4: HTTPS Fallback with Homebrew Git
If SSH consistently fails:
```bash
git remote set-url origin https://github.com/USERNAME/REPO_NAME.git
git push -u origin main
```
This works if Homebrew git (with OpenSSL) is installed. If it still shows
LibreSSL errors, you need to `brew install git` first.

#### Level 5: GitHub API Upload (nuclear option)
Upload files one-by-one via the GitHub API:
```bash
TOKEN=$(gh auth token)
CURL="/opt/homebrew/opt/curl/bin/curl"

$CURL -s -X PUT \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/vnd.github.v3+json" \
  --http1.1 \
  -d "{\"message\":\"Add FILE\",\"content\":\"$(base64 -i FILE | tr -d '\n')\"}" \
  "https://api.github.com/repos/USERNAME/REPO/contents/FILE"
```

### Step 2.4 ‚Äî Verify GitHub Upload

```bash
gh api repos/USERNAME/REPO_NAME/contents/ --jq '.[] | "\(.type)\t\(.name)"'
```

Ensure all expected files/directories appear.

---

## Phase 3: Deploy to Vercel

### Step 3.1 ‚Äî Determine Framework

| Project Type | Framework Value | Build Command | Output Dir |
|---|---|---|---|
| Static HTML (single file) | `null` | `""` (empty) | `"."` |
| Vite + React | `"vite"` | `"npm run build"` | `"dist"` |
| Next.js | `"nextjs"` | `"npm run build"` | `".next"` |
| Astro | `"astro"` | `"npm run build"` | `"dist"` |

### Step 3.2 ‚Äî Create Vercel Project

Use the Vercel API to create a project linked to the GitHub repo:

```bash
curl -s -X POST "https://api.vercel.com/v10/projects" \
  -H "Authorization: Bearer $VERCEL_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "REPO_NAME",
    "framework": FRAMEWORK_VALUE,
    "gitRepository": {
      "type": "github",
      "repo": "USERNAME/REPO_NAME"
    },
    "buildCommand": "BUILD_COMMAND",
    "outputDirectory": "OUTPUT_DIR"
  }'
```

For static HTML sites, use:
- `"framework": null`
- `"buildCommand": ""`
- `"outputDirectory": "."`

### Step 3.3 ‚Äî Trigger Production Deployment

```bash
curl -s -X POST "https://api.vercel.com/v13/deployments" \
  -H "Authorization: Bearer $VERCEL_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "REPO_NAME",
    "project": "PROJECT_ID",
    "gitSource": {
      "type": "github",
      "org": "USERNAME",
      "repo": "REPO_NAME",
      "ref": "main"
    },
    "target": "production"
  }'
```

### Step 3.4 ‚Äî Wait for Deployment

Poll the deployment status until it's READY:

```bash
# Using Vercel MCP tool
vercel_list_deployments(projectId="REPO_NAME", limit=1)
```

Or via API:
```bash
curl -s "https://api.vercel.com/v13/deployments/DEPLOYMENT_ID" \
  -H "Authorization: Bearer $VERCEL_TOKEN" \
  | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['readyState'], d.get('alias',[]))"
```

Expected states: `INITIALIZING` ‚Üí `BUILDING` ‚Üí `READY`

If `ERROR`: Check build logs and fix the issue.

### Step 3.5 ‚Äî Extract Live URLs

The deployment will have multiple URLs:
- **Production:** `https://REPO_NAME.vercel.app` (primary)
- **Branch:** `https://REPO_NAME-git-main-*.vercel.app`
- **Deployment:** `https://REPO_NAME-HASH-*.vercel.app`

Always share the **production URL** with the user: `https://REPO_NAME.vercel.app`

---

## Phase 4: Verify and Deliver

### Step 4.1 ‚Äî Browser Verification

Use `browser_subagent` to:
1. Navigate to the production URL
2. Wait 5+ seconds for CDN assets to load
3. Screenshot the hero/top section
4. Scroll through and screenshot 2-3 more sections
5. Verify: no broken images, no placeholder text, brand colors applied

### Step 4.2 ‚Äî Report to User

Present:
- ‚úÖ The live URL (clickable markdown link)
- ‚úÖ The GitHub repo URL
- ‚úÖ Screenshot confirmation
- ‚úÖ Note that future pushes to `main` auto-deploy

---

## Quick Reference: Common Errors

| Error | Cause | Fix |
|---|---|---|
| `LibreSSL SSL_read: bad record mac` | System git uses broken LibreSSL | `brew install git` |
| `Connection closed by remote host` | ISP throttling / network drop | Chunked pushing (Phase 2.3 Level 2) |
| `Permission denied (publickey)` | No SSH key on GitHub | `gh ssh-key add ~/.ssh/id_ed25519.pub` |
| `rejected: fetch first` | Remote has different commits | `git push --force origin main` |
| `HTTP 403: Must have admin rights` | Missing `delete_repo` scope | `gh auth refresh -s delete_repo` |
| `embedded git repository` | Nested `.git` folder | `git rm --cached path && .gitignore` |
| Vercel `BUILDING` never completes | Wrong framework / build cmd | Check Step 3.1 table |
| Vercel 404 on live URL | Wrong output directory | Set `outputDirectory: "."` for static |

---

## Anti-Patterns (Things That DO NOT Work)

- ‚ùå `git config --global http.sslBackend openssl` ‚Äî Does nothing if git binary is linked to system curl
- ‚ùå `GIT_SSL_NO_VERIFY=true` ‚Äî Doesn't fix bad record MAC
- ‚ùå `DYLD_LIBRARY_PATH` to override curl ‚Äî Partially works but unreliable
- ‚ùå `git config --global url."git@github.com:".insteadOf "https://github.com/"` ‚Äî Breaks HTTPS fallback
- ‚ùå SSH port 443 (`ssh.github.com`) ‚Äî Still gets killed by ISP throttling
- ‚ùå Pushing `package-lock.json` on flaky networks ‚Äî Always times out (5000+ lines)
